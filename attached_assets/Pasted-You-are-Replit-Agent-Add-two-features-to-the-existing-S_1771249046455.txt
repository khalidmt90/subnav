You are Replit Agent.

Add two features to the existing Subscriptions Radar (`/mobile`) Expo app:
1. **"Cancel Subscription" button** â€” opens the merchant's official cancellation page in the in-app browser
2. **"How to Cancel" accordion** â€” step-by-step Arabic/English guide specific to each merchant, expandable inline on the detail screen

Both features live inside `SubscriptionDetailScreen.tsx`. The design has been approved â€” follow every spec below exactly.

---

## DEPENDENCIES

```bash
npx expo install expo-web-browser
npx expo install expo-linking
```

---

## PART 1 â€” CANCEL URL DATABASE

### File: `mobile/src/data/cancelUrls.ts`

Create a typed record of known merchant cancellation URLs + how-to steps.

```ts
export type CancelStep = {
  titleAr: string;
  titleEn: string;
  descAr?: string;
  descEn?: string;
  linkUrl?: string;       // optional: a direct link shown inside the step
  linkLabelAr?: string;
  linkLabelEn?: string;
};

export type MerchantCancelInfo = {
  cancelUrl: string;          // direct URL to open in browser
  cancelUrlLabel: { ar: string; en: string };
  stepsAr: CancelStep[];      // max 5 steps
  durationAr: string;         // e.g. "Ø¯Ù‚ÙŠÙ‚ØªØ§Ù† Â· Ù¤ Ø®Ø·ÙˆØ§Øª"
  durationEn: string;
  note?: { ar: string; en: string }; // optional warning note
};

// Key = merchant name lowercase (normalize before lookup)
export const CANCEL_INFO: Record<string, MerchantCancelInfo> = {

  netflix: {
    cancelUrl: 'https://www.netflix.com/cancelplan',
    cancelUrlLabel: { ar: 'ØµÙØ­Ø© Ø¥Ù„ØºØ§Ø¡ Netflix', en: 'Netflix Cancel Page' },
    durationAr: 'Ù¤ Ø®Ø·ÙˆØ§Øª Â· Ø¯Ù‚ÙŠÙ‚ØªØ§Ù†',
    durationEn: '4 steps Â· 2 minutes',
    note: {
      ar: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ iPhone â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØµÙØ­',
      en: 'Cannot cancel from iPhone app â€” use browser',
    },
    stepsAr: [
      {
        titleAr: 'Ø§ÙØªØ­ netflix.com',
        titleEn: 'Open netflix.com',
        descAr: 'Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­ (Safari Ø£Ùˆ Chrome) â€” Ù„ÙŠØ³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
        descEn: 'In browser (Safari or Chrome) â€” not the app',
        linkUrl: 'https://www.netflix.com/cancelplan',
        linkLabelAr: 'Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡',
        linkLabelEn: 'Open cancel page',
      },
      {
        titleAr: 'Ø§Ø¶ØºØ· ØµÙˆØ±Ø© Ø­Ø³Ø§Ø¨Ùƒ',
        titleEn: 'Tap your profile picture',
        descAr: 'ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ØŒ Ø«Ù… Ø§Ø®ØªØ± "Ø§Ù„Ø­Ø³Ø§Ø¨"',
        descEn: 'Top right corner, then select "Account"',
      },
      {
        titleAr: 'Ø§Ø¨Ø­Ø« Ø¹Ù† "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©"',
        titleEn: 'Find "Cancel Membership"',
        descAr: 'ÙÙŠ Ù‚Ø³Ù… "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±"',
        descEn: 'Under "Membership & Billing" section',
      },
      {
        titleAr: 'Ø£ÙƒÙ‘Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡',
        titleEn: 'Confirm cancellation',
        descAr: 'Ø³ØªØ¨Ù‚Ù‰ Ù‚Ø§Ø¯Ø±Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ±Ø© Ø§Ù„ÙÙˆØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
        descEn: 'You keep access until end of current billing period',
      },
    ],
  },

  spotify: {
    cancelUrl: 'https://www.spotify.com/account/subscription/',
    cancelUrlLabel: { ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ø´ØªØ±Ø§Ùƒ Spotify', en: 'Manage Spotify Subscription' },
    durationAr: 'Ù£ Ø®Ø·ÙˆØ§Øª Â· Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©',
    durationEn: '3 steps Â· 1 minute',
    stepsAr: [
      {
        titleAr: 'Ø§ÙØªØ­ spotify.com/account',
        titleEn: 'Open spotify.com/account',
        descAr: 'Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¥Ø°Ø§ Ø·ÙÙ„Ø¨ Ù…Ù†Ùƒ',
        descEn: 'Log in if prompted',
        linkUrl: 'https://www.spotify.com/account/subscription/',
        linkLabelAr: 'Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
        linkLabelEn: 'Open subscription page',
      },
      {
        titleAr: 'Ø§Ø¶ØºØ· "ØªØºÙŠÙŠØ± Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø®Ø·Ø©"',
        titleEn: 'Tap "Change or cancel plan"',
        descAr: 'Ø¶Ù…Ù† Ù‚Ø³Ù… "Ø®Ø·Ø© Spotify"',
        descEn: 'Under the "Spotify plan" section',
      },
      {
        titleAr: 'Ø§Ø®ØªØ± "Ø¥Ù„ØºØ§Ø¡ Premium"',
        titleEn: 'Select "Cancel Premium"',
        descAr: 'Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª ÙˆØ£ÙƒÙ‘Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡',
        descEn: 'Follow the steps and confirm',
      },
    ],
  },

  'apple music': {
    cancelUrl: 'https://appleid.apple.com/account/manage',
    cancelUrlLabel: { ar: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Apple ID', en: 'Apple ID Settings' },
    durationAr: 'Ù¤ Ø®Ø·ÙˆØ§Øª Â· Ø¯Ù‚ÙŠÙ‚ØªØ§Ù†',
    durationEn: '4 steps Â· 2 minutes',
    note: {
      ar: 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª iPhone',
      en: 'You can cancel directly from iPhone Settings',
    },
    stepsAr: [
      {
        titleAr: 'Ø§ÙØªØ­ "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" Ø¹Ù„Ù‰ iPhone',
        titleEn: 'Open "Settings" on iPhone',
        descAr: 'Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù…Ùƒ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰',
        descEn: 'Then tap your name at the top',
      },
      {
        titleAr: 'Ø§Ø¶ØºØ· "Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª"',
        titleEn: 'Tap "Subscriptions"',
        descAr: 'Ø³ØªØ¬Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ø´ØªØ±Ø§ÙƒØ§ØªÙƒ Ø§Ù„Ù†Ø´Ø·Ø©',
        descEn: 'You\'ll see all your active subscriptions',
      },
      {
        titleAr: 'Ø§Ø®ØªØ± "Apple Music"',
        titleEn: 'Select "Apple Music"',
        descAr: 'Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª',
        descEn: 'From the subscriptions list',
      },
      {
        titleAr: 'Ø§Ø¶ØºØ· "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"',
        titleEn: 'Tap "Cancel Subscription"',
        descAr: 'Ø£ÙƒÙ‘Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ â€” ØªØ¨Ù‚Ù‰ Ø§Ù„Ù†ØºÙ…Ø§Øª Ù…ØªØ§Ø­Ø© Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©',
        descEn: 'Confirm â€” music stays available until period ends',
      },
    ],
  },

  youtube: {
    cancelUrl: 'https://www.youtube.com/paid_memberships',
    cancelUrlLabel: { ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ø´ØªØ±Ø§Ùƒ YouTube', en: 'Manage YouTube Subscription' },
    durationAr: 'Ù£ Ø®Ø·ÙˆØ§Øª Â· Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©',
    durationEn: '3 steps Â· 1 minute',
    stepsAr: [
      {
        titleAr: 'Ø§ÙØªØ­ YouTube ÙˆØ³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        titleEn: 'Open YouTube and sign in',
        linkUrl: 'https://www.youtube.com/paid_memberships',
        linkLabelAr: 'Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©',
        linkLabelEn: 'Open memberships page',
      },
      {
        titleAr: 'Ø§Ø¶ØºØ· ØµÙˆØ±Ø© Ø­Ø³Ø§Ø¨Ùƒ â† "Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª"',
        titleEn: 'Tap profile â†’ "Purchases and memberships"',
        descAr: 'Ø£Ùˆ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ youtube.com/paid_memberships',
        descEn: 'Or go to youtube.com/paid_memberships',
      },
      {
        titleAr: 'Ø§Ø¶ØºØ· "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©"',
        titleEn: 'Tap "Cancel membership"',
        descAr: 'Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ YouTube Premium ÙˆØ£ÙƒÙ‘Ø¯',
        descEn: 'Next to YouTube Premium and confirm',
      },
    ],
  },

  amazon: {
    cancelUrl: 'https://www.amazon.sa/mc/pipelines/memberships',
    cancelUrlLabel: { ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ø´ØªØ±Ø§Ùƒ Amazon', en: 'Manage Amazon Subscription' },
    durationAr: 'Ù¤ Ø®Ø·ÙˆØ§Øª Â· Ø¯Ù‚ÙŠÙ‚ØªØ§Ù†',
    durationEn: '4 steps Â· 2 minutes',
    stepsAr: [
      {
        titleAr: 'Ø§ÙØªØ­ amazon.sa ÙˆØ³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        titleEn: 'Open amazon.sa and sign in',
        linkUrl: 'https://www.amazon.sa/mc/pipelines/memberships',
        linkLabelAr: 'Ø§ÙØªØ­ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©',
        linkLabelEn: 'Open membership management',
      },
      {
        titleAr: 'Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ÙŠ â† Prime',
        titleEn: 'Go to Account â†’ Prime',
        descAr: 'Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        descEn: 'From the main menu',
      },
      {
        titleAr: 'Ø§Ø¶ØºØ· "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©"',
        titleEn: 'Tap "Manage Membership"',
        descAr: 'Ø«Ù… "Ø¥Ù†Ù‡Ø§Ø¡ Ø¹Ø¶ÙˆÙŠØ© Prime"',
        descEn: 'Then "End Prime Membership"',
      },
      {
        titleAr: 'Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙˆØ£ÙƒÙ‘Ø¯',
        titleEn: 'Select a reason and confirm',
        descAr: 'ØªØ¨Ù‚Ù‰ Ø§Ù„Ù…Ø²Ø§ÙŠØ§ Ù…ØªØ§Ø­Ø© Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
        descEn: 'Benefits remain until end of current period',
      },
    ],
  },

  stc: {
    cancelUrl: 'https://www.stc.com.sa/wps/portal/stcsa/personal/myservices',
    cancelUrlLabel: { ar: 'Ø®Ø¯Ù…Ø§ØªÙŠ ÙÙŠ STC', en: 'My STC Services' },
    durationAr: 'Ù£ Ø®Ø·ÙˆØ§Øª',
    durationEn: '3 steps',
    stepsAr: [
      {
        titleAr: 'Ø§ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ MySTC',
        titleEn: 'Open MySTC app',
        descAr: 'Ø£Ùˆ Ø²ÙØ± stc.com.sa ÙˆØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ',
        descEn: 'Or visit stc.com.sa and log in',
      },
      {
        titleAr: 'Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ "Ø®Ø¯Ù…Ø§ØªÙŠ"',
        titleEn: 'Go to "My Services"',
        descAr: 'Ø³ØªØ¬Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©',
        descEn: 'You\'ll see all active subscriptions',
      },
      {
        titleAr: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ£Ù„ØºÙÙ‡Ø§',
        titleEn: 'Find the service and cancel',
        descAr: 'Ø§Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ£ÙƒÙ‘Ø¯ Ø¹Ø¨Ø± Ø±Ø³Ø§Ù„Ø© OTP',
        descEn: 'Tap cancel and confirm via OTP message',
      },
    ],
  },

  anghami: {
    cancelUrl: 'https://accounts.anghami.com/subscription',
    cancelUrlLabel: { ar: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ø´ØªØ±Ø§Ùƒ Anghami', en: 'Manage Anghami Subscription' },
    durationAr: 'Ù£ Ø®Ø·ÙˆØ§Øª Â· Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©',
    durationEn: '3 steps Â· 1 minute',
    stepsAr: [
      {
        titleAr: 'Ø§ÙØªØ­ accounts.anghami.com',
        titleEn: 'Open accounts.anghami.com',
        linkUrl: 'https://accounts.anghami.com/subscription',
        linkLabelAr: 'Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
        linkLabelEn: 'Open subscription page',
      },
      {
        titleAr: 'Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ ÙˆØ§Ù†ØªÙ‚Ù„ Ù„Ù€ "Ø§Ø´ØªØ±Ø§ÙƒÙŠ"',
        titleEn: 'Log in and go to "My Subscription"',
      },
      {
        titleAr: 'Ø§Ø¶ØºØ· "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" ÙˆØ£ÙƒÙ‘Ø¯',
        titleEn: 'Tap "Cancel Subscription" and confirm',
        descAr: 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø©',
        descEn: 'You can keep listening until the period ends',
      },
    ],
  },

  // Fallback for unknown merchants
  _default: {
    cancelUrl: '',   // will use Google search fallback
    cancelUrlLabel: { ar: 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡', en: 'Search how to cancel' },
    durationAr: 'Ø®Ø·ÙˆØ§Øª Ø¹Ø§Ù…Ø©',
    durationEn: 'General steps',
    stepsAr: [
      {
        titleAr: 'Ø§Ø¨Ø­Ø« ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
        titleEn: 'Check app settings',
        descAr: 'Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ â† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨',
        descEn: 'Open app â†’ Settings â†’ Subscription or Account',
      },
      {
        titleAr: 'Ø£Ùˆ Ø±Ø§Ø¬Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª iPhone',
        titleEn: 'Or check iPhone Settings',
        descAr: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â† Ø§Ø³Ù…Ùƒ â† Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª',
        descEn: 'Settings â†’ Your Name â†’ Subscriptions',
      },
      {
        titleAr: 'Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¹Ù„Ù‰ Google',
        titleEn: 'Or search Google',
        descAr: 'Ø§Ø¨Ø­Ø« Ø¹Ù† "ÙƒÙŠÙÙŠØ© Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ [Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©]"',
        descEn: 'Search "how to cancel [service name] subscription"',
      },
    ],
  },
};

/**
 * Get cancel info for a merchant.
 * Normalizes the name and falls back to _default.
 */
export function getCancelInfo(merchant: string): MerchantCancelInfo & { isKnown: boolean } {
  const key = merchant.toLowerCase().trim();
  const info = CANCEL_INFO[key] ?? CANCEL_INFO['_default'];
  const isKnown = key in CANCEL_INFO && key !== '_default';

  // For unknown merchants, generate a Google search URL
  if (!isKnown) {
    return {
      ...info,
      cancelUrl: `https://www.google.com/search?q=ÙƒÙŠÙÙŠØ©+Ø¥Ù„ØºØ§Ø¡+Ø§Ø´ØªØ±Ø§Ùƒ+${encodeURIComponent(merchant)}`,
      isKnown: false,
    };
  }
  return { ...info, isKnown: true };
}
```

---

## PART 2 â€” SubscriptionDetailScreen.tsx

### File: `mobile/src/screens/SubscriptionDetailScreen.tsx`

Full screen implementation. The screen receives a `subscription` object via navigation params.

```tsx
import React, { useState, useCallback, useRef } from 'react';
import {
  View, Text, ScrollView, Pressable,
  StyleSheet, Platform, Linking, Animated,
  LayoutAnimation, UIManager,
} from 'react-native';
import * as WebBrowser from 'expo-web-browser';
import { LinearGradient } from 'expo-linear-gradient';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import { Colors, FontSize, Radii } from '../theme/tokens';
import { getCancelInfo, CancelStep } from '../data/cancelUrls';
import { useI18n } from '../hooks/useI18n';
import { supabase } from '../lib/supabase';

// Enable LayoutAnimation on Android
if (Platform.OS === 'android' && UIManager.setLayoutAnimationEnabledExperimental) {
  UIManager.setLayoutAnimationEnabledExperimental(true);
}

// â”€â”€ TYPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
interface Subscription {
  id: string;
  merchant: string;
  title: string;
  category: string;
  renewal_date: string | null;
  amount_sar: number | null;
  amount_sar_override: number | null;
  is_trial: boolean;
  confidence: number;
  status: 'active' | 'muted' | 'canceled';
  source_message_id: string | null;
  // from email join:
  from_email?: string;
  subject?: string;
  snippet?: string;
}

interface Props {
  route: { params: { subscription: Subscription } };
  navigation: any;
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function daysUntil(dateStr: string | null): number | null {
  if (!dateStr) return null;
  const diff = new Date(dateStr).getTime() - Date.now();
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
}

function formatDateAr(dateStr: string | null): string {
  if (!dateStr) return 'â€“';
  return new Date(dateStr).toLocaleDateString('ar-SA', {
    year: 'numeric', month: 'long', day: 'numeric',
  });
}

function formatDateHijri(dateStr: string | null): string {
  if (!dateStr) return 'â€“';
  return new Date(dateStr).toLocaleDateString('ar-SA-u-ca-islamic', {
    year: 'numeric', month: 'long', day: 'numeric',
  });
}

function formatDateEn(dateStr: string | null): string {
  if (!dateStr) return 'â€“';
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric', month: 'short', day: 'numeric',
  });
}

function daysLabel(days: number | null, isAr: boolean): string {
  if (days === null) return 'â€“';
  if (days < 0)  return isAr ? 'Ø§Ù†ØªÙ‡Ù‰' : 'Expired';
  if (days === 0) return isAr ? 'Ø§Ù„ÙŠÙˆÙ…' : 'Today';
  if (days === 1) return isAr ? 'ØºØ¯Ø§Ù‹' : 'Tomorrow';
  return isAr ? `Ø¨Ø¹Ø¯ ${days} Ø£ÙŠØ§Ù…` : `In ${days} days`;
}

function urgencyColor(days: number | null): string {
  if (days === null) return Colors.textMuted;
  if (days <= 2)  return Colors.danger;
  if (days <= 7)  return Colors.warning;
  return Colors.textMuted;
}

function categoryLabel(cat: string, isAr: boolean): string {
  const map: Record<string, [string, string]> = {
    streaming:  ['ğŸ¬ Ø¨Ø« ÙˆØªØ±ÙÙŠÙ‡',   'ğŸ¬ Streaming'],
    software:   ['ğŸ’» Ø¨Ø±Ù…Ø¬ÙŠØ§Øª',      'ğŸ’» Software'],
    food:       ['ğŸ” Ø·Ø¹Ø§Ù…',         'ğŸ” Food'],
    finance:    ['ğŸ’³ Ù…Ø§Ù„ÙŠØ©',        'ğŸ’³ Finance'],
    telecom:    ['ğŸ“± Ø§ØªØµØ§Ù„Ø§Øª',      'ğŸ“± Telecom'],
    cloud:      ['â˜ï¸ Ø®Ø¯Ù…Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ©', 'â˜ï¸ Cloud'],
    music:      ['ğŸµ Ù…ÙˆØ³ÙŠÙ‚Ù‰',       'ğŸµ Music'],
    other:      ['ğŸ“¦ Ø£Ø®Ø±Ù‰',         'ğŸ“¦ Other'],
  };
  const entry = map[cat] ?? map['other'];
  return isAr ? entry[0] : entry[1];
}

function confidenceLabel(conf: number, isAr: boolean): string {
  if (conf >= 0.85) return isAr ? 'Ø«Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©' : 'High confidence';
  if (conf >= 0.70) return isAr ? 'Ø«Ù‚Ø© Ù…ØªÙˆØ³Ø·Ø©' : 'Medium confidence';
  return isAr ? 'Ø«Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©' : 'Low confidence';
}

function confidenceColor(conf: number): string {
  if (conf >= 0.85) return Colors.success;
  if (conf >= 0.70) return Colors.warning;
  return Colors.danger;
}

// â”€â”€ MAIN COMPONENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export function SubscriptionDetailScreen({ route, navigation }: Props) {
  const { subscription } = route.params;
  const { lang, t } = useI18n();
  const isAr = lang === 'ar';
  const insets = useSafeAreaInsets();

  const cancelInfo = getCancelInfo(subscription.merchant);
  const days = daysUntil(subscription.renewal_date);
  const amount = subscription.amount_sar_override ?? subscription.amount_sar;

  const [howtoOpen, setHowtoOpen] = useState(false);
  const [isMuting, setIsMuting] = useState(false);
  const [isCanceling, setIsCanceling] = useState(false);

  // â”€â”€ OPEN CANCEL URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleOpenCancelPage = useCallback(async () => {
    const url = cancelInfo.cancelUrl;
    if (!url) return;
    try {
      await WebBrowser.openBrowserAsync(url, {
        presentationStyle: WebBrowser.WebBrowserPresentationStyle.PAGE_SHEET,
        toolbarColor: Colors.bg,
        controlsColor: Colors.accent,
        dismissButtonStyle: 'close',
      });
    } catch {
      // Fallback to system browser
      await Linking.openURL(url);
    }
  }, [cancelInfo.cancelUrl]);

  // â”€â”€ OPEN STEP LINK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleStepLink = useCallback(async (url: string) => {
    try {
      await WebBrowser.openBrowserAsync(url, {
        presentationStyle: WebBrowser.WebBrowserPresentationStyle.PAGE_SHEET,
        toolbarColor: Colors.bg,
        controlsColor: Colors.accent,
        dismissButtonStyle: 'close',
      });
    } catch {
      await Linking.openURL(url);
    }
  }, []);

  // â”€â”€ TOGGLE HOW-TO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleToggleHowto = useCallback(() => {
    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);
    setHowtoOpen(prev => !prev);
  }, []);

  // â”€â”€ MUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleMute = useCallback(async () => {
    setIsMuting(true);
    await supabase
      .from('subscriptions')
      .update({ status: 'muted', updated_at: new Date().toISOString() })
      .eq('id', subscription.id);
    setIsMuting(false);
    navigation.goBack();
  }, [subscription.id, navigation]);

  // â”€â”€ MARK CANCELED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const handleMarkCanceled = useCallback(async () => {
    setIsCanceling(true);
    await supabase
      .from('subscriptions')
      .update({ status: 'canceled', updated_at: new Date().toISOString() })
      .eq('id', subscription.id);
    setIsCanceling(false);
    navigation.goBack();
  }, [subscription.id, navigation]);

  // â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return (
    <View style={[styles.screen, { paddingTop: insets.top }]}>

      {/* â”€â”€ NAV BAR â”€â”€ */}
      <View style={styles.navBar}>
        <Pressable
          style={styles.navBtn}
          onPress={() => navigation.goBack()}
          hitSlop={8}
        >
          {/* Back arrow â€” flipped in RTL by I18nManager */}
          <Text style={styles.navBtnIcon}>â€¹</Text>
        </Pressable>
        <Text style={styles.navTitle}>
          {isAr ? 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ' : 'Subscription Details'}
        </Text>
        <View style={styles.navBtn} />
      </View>

      <ScrollView
        style={styles.scroll}
        contentContainerStyle={styles.scrollContent}
        showsVerticalScrollIndicator={false}
      >

        {/* â”€â”€ HERO â”€â”€ */}
        <View style={styles.hero}>
          {/* Merchant icon */}
          <View style={styles.merchantLogo}>
            <Text style={styles.merchantEmoji}>
              {getMerchantEmoji(subscription.merchant)}
            </Text>
            {/* Status ring */}
            <View style={[
              styles.statusRing,
              { borderColor: days !== null && days <= 3 ? Colors.danger : Colors.warning }
            ]} />
          </View>
          <Text style={styles.merchantName}>{subscription.merchant}</Text>
          <View style={styles.badgeRow}>
            {/* Category badge */}
            <View style={styles.catBadge}>
              <Text style={styles.catBadgeText}>
                {categoryLabel(subscription.category, isAr)}
              </Text>
            </View>
            {/* Trial badge */}
            {subscription.is_trial && (
              <View style={styles.trialBadge}>
                <Text style={styles.trialBadgeText}>
                  {isAr ? 'â± ØªØ¬Ø±Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ©' : 'â± Free Trial'}
                </Text>
              </View>
            )}
          </View>
        </View>

        <View style={styles.divider} />

        {/* â”€â”€ INFO GRID â”€â”€ */}
        <View style={styles.infoGrid}>
          {/* Amount */}
          <View style={styles.infoCard}>
            <Text style={styles.icLabel}>{isAr ? 'Ø§Ù„Ù…Ø¨Ù„Øº' : 'Amount'}</Text>
            <Text style={styles.icValue}>
              {amount
                ? isAr ? `${amount} Ø±ÙŠØ§Ù„` : `SAR ${amount}`
                : isAr ? 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' : 'Unknown'
              }
            </Text>
            <Text style={styles.icSub}>{isAr ? 'Ø´Ù‡Ø±ÙŠØ§Ù‹' : 'per month'}</Text>
          </View>
          {/* Days */}
          <View style={styles.infoCard}>
            <Text style={styles.icLabel}>{isAr ? 'Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯' : 'Renews'}</Text>
            <Text style={[styles.icValue, { color: urgencyColor(days) }]}>
              {daysLabel(days, isAr)}
            </Text>
            <Text style={styles.icSub}>
              {isAr
                ? formatDateAr(subscription.renewal_date)
                : formatDateEn(subscription.renewal_date)
              }
            </Text>
          </View>
          {/* Hijri date */}
          <View style={styles.infoCard}>
            <Text style={styles.icLabel}>{isAr ? 'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ' : 'Hijri Date'}</Text>
            <Text style={[styles.icValue, { fontSize: 15 }]}>
              {formatDateHijri(subscription.renewal_date)}
            </Text>
            <Text style={styles.icSub}>Ù‡Ù€</Text>
          </View>
          {/* Confidence */}
          <View style={styles.infoCard}>
            <Text style={styles.icLabel}>{isAr ? 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ù‚Ø©' : 'Confidence'}</Text>
            <Text style={[styles.icValue, { fontSize: 15, color: confidenceColor(subscription.confidence) }]}>
              {confidenceLabel(subscription.confidence, isAr)} Â· {Math.round(subscription.confidence * 100)}Ùª
            </Text>
            {/* Confidence bar */}
            <View style={styles.confBarTrack}>
              <View style={[
                styles.confBarFill,
                {
                  width: `${subscription.confidence * 100}%` as any,
                  backgroundColor: confidenceColor(subscription.confidence),
                }
              ]} />
            </View>
          </View>
          {/* Trial warning â€” full width, only if is_trial and days <= 7 */}
          {subscription.is_trial && days !== null && days <= 7 && (
            <View style={[styles.infoCard, styles.infoCardFull, styles.trialWarningCard]}>
              <Text style={styles.trialWarningLabel}>
                {isAr ? 'âš  ØªÙ†Ø¨ÙŠÙ‡' : 'âš  Warning'}
              </Text>
              <Text style={styles.trialWarningText}>
                {isAr
                  ? `Ø¥Ø°Ø§ Ù„Ù… ØªÙÙ„ØºÙ Ù‚Ø¨Ù„ ${formatDateAr(subscription.renewal_date)}ØŒ Ø³ÙŠÙØ®ØµÙ… ${amount ? amount + ' Ø±ÙŠØ§Ù„' : 'Ø§Ù„Ù…Ø¨Ù„Øº'} ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹`
                  : `If you don't cancel before ${formatDateEn(subscription.renewal_date)}, ${amount ? 'SAR ' + amount : 'the amount'} will be charged automatically`
                }
              </Text>
            </View>
          )}
        </View>

        {/* â”€â”€ SECTION: ACTIONS â”€â”€ */}
        <SectionDivider label={isAr ? 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª' : 'Actions'} />

        {/* â”€â”€ CANCEL BUTTON â€” opens official cancellation page â”€â”€ */}
        <View style={styles.section}>
          <Pressable
            style={({ pressed }) => [
              styles.cancelBtn,
              subscription.is_trial && styles.cancelBtnTrial,
              pressed && styles.cancelBtnPressed,
            ]}
            onPress={handleOpenCancelPage}
          >
            {/* Icon */}
            <View style={[
              styles.cancelBtnIconBox,
              subscription.is_trial && styles.cancelBtnIconBoxTrial,
            ]}>
              {subscription.is_trial ? (
                // Warning icon for trials
                <Text style={{ fontSize: 14 }}>âš </Text>
              ) : (
                <Text style={{ fontSize: 14 }}>â†©</Text>
              )}
            </View>

            {/* Text */}
            <View style={styles.cancelBtnText}>
              <Text style={[
                styles.cancelBtnTitle,
                subscription.is_trial && styles.cancelBtnTitleTrial,
              ]}>
                {subscription.is_trial
                  ? (isAr ? `Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ù‚Ø¨Ù„ ÙÙˆØ§Øª Ø§Ù„Ø£ÙˆØ§Ù†` : `Cancel trial before it's too late`)
                  : (isAr ? `Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ${subscription.merchant}` : `Cancel ${subscription.merchant} subscription`)
                }
              </Text>
              <Text style={styles.cancelBtnSub}>
                {cancelInfo.isKnown
                  ? (isAr ? cancelInfo.cancelUrlLabel.ar : cancelInfo.cancelUrlLabel.en)
                  : (isAr ? 'Ø³ÙŠÙØªØ­ Ø¨Ø­Ø« Google Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©' : 'Opens Google search to help')
                }
              </Text>
            </View>

            {/* Arrow */}
            <Text style={[
              styles.cancelBtnArrow,
              subscription.is_trial && { color: Colors.warning },
            ]}>â€º</Text>
          </Pressable>
        </View>

        {/* â”€â”€ SECTION: HOW TO CANCEL â”€â”€ */}
        <SectionDivider label={isAr ? 'ÙƒÙŠÙ ØªÙÙ„ØºÙŠØŸ' : 'How to cancel?'} />

        <View style={styles.section}>
          <View style={styles.howtoCard}>

            {/* Accordion header */}
            <Pressable
              style={styles.howtoHeader}
              onPress={handleToggleHowto}
            >
              <View style={styles.howtoHeaderLeft}>
                <View style={styles.howtoIconBox}>
                  <Text style={{ fontSize: 15 }}>ğŸ“–</Text>
                </View>
                <View>
                  <Text style={styles.howtoTitle}>
                    {isAr
                      ? `Ø®Ø·ÙˆØ§Øª Ø¥Ù„ØºØ§Ø¡ ${subscription.merchant}`
                      : `How to cancel ${subscription.merchant}`
                    }
                  </Text>
                  <Text style={styles.howtoSub}>
                    {isAr ? cancelInfo.durationAr : cancelInfo.durationEn}
                    {cancelInfo.note && ` Â· `}
                    {cancelInfo.note && (
                      <Text style={{ color: Colors.warning }}>
                        {isAr ? cancelInfo.note.ar : cancelInfo.note.en}
                      </Text>
                    )}
                  </Text>
                </View>
              </View>
              <Text style={[styles.chevron, howtoOpen && styles.chevronOpen]}>
                âŒ„
              </Text>
            </Pressable>

            {/* Steps â€” animated expand/collapse via LayoutAnimation */}
            {howtoOpen && (
              <View style={styles.stepsContainer}>
                {cancelInfo.stepsAr.map((step, index) => (
                  <HowToStep
                    key={index}
                    step={step}
                    index={index}
                    total={cancelInfo.stepsAr.length}
                    isAr={isAr}
                    onLinkPress={handleStepLink}
                  />
                ))}
              </View>
            )}
          </View>
        </View>

        {/* â”€â”€ SECTION: SOURCE EMAIL â”€â”€ */}
        {(subscription.from_email || subscription.subject) && (
          <>
            <SectionDivider label={isAr ? 'Ø§Ù„Ù…ØµØ¯Ø±' : 'Source'} />
            <View style={styles.section}>
              <View style={styles.emailCard}>
                {subscription.from_email && (
                  <Text style={styles.emailFrom}>{subscription.from_email}</Text>
                )}
                {subscription.subject && (
                  <Text style={styles.emailSubject}>{subscription.subject}</Text>
                )}
                {subscription.snippet && (
                  <Text style={styles.emailSnippet} numberOfLines={3}>
                    {subscription.snippet}
                  </Text>
                )}
              </View>
            </View>
          </>
        )}

        {/* â”€â”€ SECONDARY ACTIONS ROW â”€â”€ */}
        <View style={styles.actionsRow}>
          <Pressable
            style={({ pressed }) => [styles.actionBtn, pressed && styles.actionBtnPressed]}
            onPress={handleMute}
            disabled={isMuting}
          >
            <Text style={styles.actionBtnIcon}>ğŸ”‡</Text>
            <Text style={styles.actionBtnText}>{isAr ? 'ÙƒØªÙ…' : 'Mute'}</Text>
          </Pressable>

          <Pressable
            style={({ pressed }) => [styles.actionBtn, pressed && styles.actionBtnPressed]}
            onPress={handleMarkCanceled}
            disabled={isCanceling}
          >
            <Text style={styles.actionBtnIcon}>âœ“</Text>
            <Text style={styles.actionBtnText}>{isAr ? 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡' : 'Canceled'}</Text>
          </Pressable>

          <Pressable
            style={({ pressed }) => [styles.actionBtn, pressed && styles.actionBtnPressed]}
          >
            <Text style={styles.actionBtnIcon}>ğŸ—„</Text>
            <Text style={styles.actionBtnText}>{isAr ? 'Ø£Ø±Ø´ÙØ©' : 'Archive'}</Text>
          </Pressable>
        </View>

        {/* Bottom safe area padding */}
        <View style={{ height: insets.bottom + 24 }} />
      </ScrollView>
    </View>
  );
}

// â”€â”€ HOW-TO STEP COMPONENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function HowToStep({
  step, index, total, isAr, onLinkPress,
}: {
  step: CancelStep;
  index: number;
  total: number;
  isAr: boolean;
  onLinkPress: (url: string) => void;
}) {
  // Convert index to Arabic numeral
  const arabicNumerals = ['Ù¡','Ù¢','Ù£','Ù¤','Ù¥'];
  const num = isAr ? (arabicNumerals[index] ?? String(index + 1)) : String(index + 1);

  return (
    <View style={[
      styles.stepItem,
      index < total - 1 && styles.stepItemNotLast,
    ]}>
      {/* Number circle with connecting line */}
      <View style={styles.stepLeft}>
        <View style={styles.stepNum}>
          <Text style={styles.stepNumText}>{num}</Text>
        </View>
        {/* Vertical connector line */}
        {index < total - 1 && <View style={styles.stepLine} />}
      </View>

      {/* Content */}
      <View style={styles.stepContent}>
        <Text style={styles.stepTitle}>
          {isAr ? step.titleAr : step.titleEn}
        </Text>
        {(isAr ? step.descAr : step.descEn) && (
          <Text style={styles.stepDesc}>
            {isAr ? step.descAr : step.descEn}
          </Text>
        )}
        {/* Optional deep link inside step */}
        {step.linkUrl && (
          <Pressable
            style={styles.stepLink}
            onPress={() => onLinkPress(step.linkUrl!)}
          >
            <Text style={styles.stepLinkText}>
              â†— {isAr ? step.linkLabelAr : step.linkLabelEn}
            </Text>
          </Pressable>
        )}
      </View>
    </View>
  );
}

// â”€â”€ SECTION DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SectionDivider({ label }: { label: string }) {
  return (
    <View style={styles.sectionDivider}>
      <View style={styles.sectionDividerLine} />
      <Text style={styles.sectionDividerLabel}>{label}</Text>
      <View style={styles.sectionDividerLine} />
    </View>
  );
}

// â”€â”€ MERCHANT EMOJI HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMerchantEmoji(merchant: string): string {
  const map: Record<string, string> = {
    netflix: 'ğŸ¬', spotify: 'ğŸµ', 'apple music': 'ğŸµ', youtube: 'â–¶ï¸',
    amazon: 'ğŸ“¦', anghami: 'ğŸ¶', stc: 'ğŸ“±', 'microsoft 365': 'ğŸ’¼',
    adobe: 'ğŸ¨', dropbox: 'ğŸ“', icloud: 'â˜ï¸', google: 'ğŸ”',
    zoom: 'ğŸ“¹', slack: 'ğŸ’¬', github: 'ğŸ’»', notion: 'ğŸ“',
  };
  return map[merchant.toLowerCase()] ?? 'ğŸ“‹';
}

// â”€â”€ STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const styles = StyleSheet.create({
  screen: {
    flex: 1,
    backgroundColor: Colors.bg,
  },
  navBar: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingVertical: 10,
  },
  navBtn: {
    width: 36, height: 36,
    backgroundColor: Colors.surface2,
    borderRadius: 10,
    borderWidth: 1, borderColor: Colors.border,
    alignItems: 'center', justifyContent: 'center',
  },
  navBtnIcon: {
    fontSize: 22, color: Colors.text, lineHeight: 26,
  },
  navTitle: {
    fontSize: 16, fontWeight: '600',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    color: Colors.text,
  },
  scroll: { flex: 1 },
  scrollContent: { paddingBottom: 20 },

  // Hero
  hero: {
    alignItems: 'center',
    paddingHorizontal: 20,
    paddingVertical: 20,
    gap: 10,
  },
  merchantLogo: {
    width: 72, height: 72,
    borderRadius: 20,
    backgroundColor: Colors.surface2,
    alignItems: 'center', justifyContent: 'center',
    position: 'relative',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.4, shadowRadius: 16,
    elevation: 6,
  },
  merchantEmoji: { fontSize: 32 },
  statusRing: {
    position: 'absolute',
    inset: -3,
    borderRadius: 23,
    borderWidth: 1.5,
    opacity: 0.5,
    // React Native doesn't support CSS inset â€” use:
    top: -3, left: -3, right: -3, bottom: -3,
  },
  merchantName: {
    fontSize: 22, fontWeight: '700',
    fontFamily: 'IBMPlexSansArabic_700Bold',
    color: Colors.text, letterSpacing: -0.3,
  },
  badgeRow: {
    flexDirection: 'row', gap: 8, flexWrap: 'wrap', justifyContent: 'center',
  },
  catBadge: {
    backgroundColor: 'rgba(91,108,248,0.12)',
    borderWidth: 1, borderColor: 'rgba(91,108,248,0.2)',
    borderRadius: 20, paddingVertical: 3, paddingHorizontal: 10,
  },
  catBadgeText: {
    fontSize: 11, fontWeight: '600', color: '#8B8CF8',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    letterSpacing: 0.3,
  },
  trialBadge: {
    backgroundColor: 'rgba(250,192,109,0.12)',
    borderWidth: 1, borderColor: 'rgba(250,192,109,0.28)',
    borderRadius: 20, paddingVertical: 3, paddingHorizontal: 10,
  },
  trialBadgeText: {
    fontSize: 11, fontWeight: '700', color: Colors.warning,
    fontFamily: 'IBMPlexSansArabic_700Bold',
  },
  divider: {
    height: 1, backgroundColor: Colors.border,
    marginHorizontal: 20,
  },

  // Info grid
  infoGrid: {
    flexDirection: 'row', flexWrap: 'wrap',
    gap: 10, padding: 16,
  },
  infoCard: {
    flex: 1, minWidth: '45%',
    backgroundColor: Colors.surface,
    borderRadius: Radii.card,
    borderWidth: 1, borderColor: Colors.border,
    padding: 14,
  },
  infoCardFull: { minWidth: '100%', flex: 0 },
  icLabel: {
    fontSize: 11, fontWeight: '600',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    color: Colors.muted, textTransform: 'uppercase',
    letterSpacing: 0.6, marginBottom: 5,
  },
  icValue: {
    fontSize: 18, fontWeight: '700',
    fontFamily: 'IBMPlexSansArabic_700Bold',
    color: Colors.text, lineHeight: 22,
  },
  icSub: {
    fontSize: 12, color: Colors.textMuted, marginTop: 3,
    fontFamily: 'IBMPlexSansArabic_400Regular',
  },
  confBarTrack: {
    height: 4, backgroundColor: 'rgba(255,255,255,0.08)',
    borderRadius: 2, marginTop: 8, overflow: 'hidden',
  },
  confBarFill: {
    height: 4, borderRadius: 2,
  },
  trialWarningCard: {
    backgroundColor: 'rgba(250,192,109,0.06)',
    borderColor: 'rgba(250,192,109,0.2)',
  },
  trialWarningLabel: {
    fontSize: 11, fontWeight: '600', color: Colors.warning,
    textTransform: 'uppercase', letterSpacing: 0.6, marginBottom: 5,
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
  },
  trialWarningText: {
    fontSize: 13, color: '#E0D0A0', lineHeight: 20,
    fontFamily: 'IBMPlexSansArabic_400Regular',
  },

  // Section divider
  sectionDivider: {
    flexDirection: 'row', alignItems: 'center',
    paddingHorizontal: 16, paddingVertical: 14, gap: 10,
  },
  sectionDividerLine: {
    flex: 1, height: 1, backgroundColor: Colors.border,
  },
  sectionDividerLabel: {
    fontSize: 11, fontWeight: '700',
    fontFamily: 'IBMPlexSansArabic_700Bold',
    color: Colors.muted, textTransform: 'uppercase',
    letterSpacing: 0.7,
  },

  // Cancel button
  section: { paddingHorizontal: 16, marginBottom: 4 },
  cancelBtn: {
    flexDirection: 'row', alignItems: 'center',
    backgroundColor: 'rgba(250,109,138,0.08)',
    borderWidth: 1.5, borderColor: 'rgba(250,109,138,0.3)',
    borderRadius: 16, padding: 14, gap: 12,
    minHeight: 54,
  },
  cancelBtnTrial: {
    backgroundColor: 'rgba(250,192,109,0.08)',
    borderColor: 'rgba(250,192,109,0.35)',
  },
  cancelBtnPressed: { opacity: 0.75 },
  cancelBtnIconBox: {
    width: 32, height: 32,
    backgroundColor: 'rgba(250,109,138,0.15)',
    borderRadius: 9,
    alignItems: 'center', justifyContent: 'center',
  },
  cancelBtnIconBoxTrial: {
    backgroundColor: 'rgba(250,192,109,0.15)',
  },
  cancelBtnText: { flex: 1 },
  cancelBtnTitle: {
    fontSize: 15, fontWeight: '600',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    color: Colors.danger, lineHeight: 20,
  },
  cancelBtnTitleTrial: { color: Colors.warning },
  cancelBtnSub: {
    fontSize: 11, color: Colors.textMuted,
    fontFamily: 'IBMPlexSansArabic_400Regular',
    marginTop: 2,
  },
  cancelBtnArrow: {
    fontSize: 20, color: Colors.danger, opacity: 0.8,
  },

  // How-to card
  howtoCard: {
    backgroundColor: Colors.surface,
    borderWidth: 1, borderColor: Colors.border,
    borderRadius: 16, overflow: 'hidden',
  },
  howtoHeader: {
    flexDirection: 'row', alignItems: 'center',
    justifyContent: 'space-between',
    padding: 14, gap: 10,
  },
  howtoHeaderLeft: {
    flexDirection: 'row', alignItems: 'center',
    gap: 10, flex: 1,
  },
  howtoIconBox: {
    width: 32, height: 32,
    backgroundColor: 'rgba(91,108,248,0.15)',
    borderRadius: 9,
    alignItems: 'center', justifyContent: 'center',
  },
  howtoTitle: {
    fontSize: 14, fontWeight: '600',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    color: Colors.text,
  },
  howtoSub: {
    fontSize: 11, color: Colors.textMuted,
    fontFamily: 'IBMPlexSansArabic_400Regular',
    marginTop: 2,
  },
  chevron: {
    fontSize: 18, color: Colors.muted,
    transform: [{ rotate: '0deg' }],
  },
  chevronOpen: {
    transform: [{ rotate: '180deg' }],
  },

  // Steps
  stepsContainer: {
    borderTopWidth: 1, borderTopColor: Colors.border,
    paddingHorizontal: 16, paddingVertical: 8,
  },
  stepItem: {
    flexDirection: 'row', gap: 12,
    paddingVertical: 10,
  },
  stepItemNotLast: {
    // The line connector is handled by stepLine absolute position
  },
  stepLeft: {
    alignItems: 'center', width: 30,
  },
  stepNum: {
    width: 30, height: 30,
    borderRadius: 15,
    backgroundColor: Colors.surface2,
    borderWidth: 1.5, borderColor: 'rgba(91,108,248,0.25)',
    alignItems: 'center', justifyContent: 'center',
    zIndex: 1,
  },
  stepNumText: {
    fontSize: 12, fontWeight: '700',
    fontFamily: 'IBMPlexSansArabic_700Bold',
    color: Colors.accent,
  },
  stepLine: {
    flex: 1, width: 2,
    backgroundColor: Colors.border,
    borderRadius: 1, marginTop: 2,
    minHeight: 16,
  },
  stepContent: {
    flex: 1, paddingTop: 4, paddingBottom: 10,
  },
  stepTitle: {
    fontSize: 13, fontWeight: '600',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    color: Colors.text, lineHeight: 19, marginBottom: 3,
  },
  stepDesc: {
    fontSize: 12, color: Colors.textMuted,
    fontFamily: 'IBMPlexSansArabic_400Regular',
    lineHeight: 18,
  },
  stepLink: {
    marginTop: 6,
    flexDirection: 'row', alignItems: 'center',
    backgroundColor: 'rgba(91,108,248,0.10)',
    borderWidth: 1, borderColor: 'rgba(91,108,248,0.2)',
    borderRadius: 8, paddingVertical: 4, paddingHorizontal: 10,
    alignSelf: 'flex-start',
  },
  stepLinkText: {
    fontSize: 12, fontWeight: '600',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    color: Colors.accent,
  },

  // Email card
  emailCard: {
    backgroundColor: Colors.surface,
    borderWidth: 1, borderColor: Colors.border,
    borderRadius: 16, padding: 16,
  },
  emailFrom: {
    fontSize: 11, fontWeight: '600', color: Colors.muted,
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    textTransform: 'uppercase', letterSpacing: 0.5,
    marginBottom: 6,
  },
  emailSubject: {
    fontSize: 13, fontWeight: '600',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    color: Colors.text, marginBottom: 6, lineHeight: 19,
  },
  emailSnippet: {
    fontSize: 12, color: Colors.textMuted,
    fontFamily: 'IBMPlexSansArabic_400Regular',
    lineHeight: 18,
  },

  // Secondary actions
  actionsRow: {
    flexDirection: 'row', gap: 10,
    paddingHorizontal: 16, paddingTop: 8,
  },
  actionBtn: {
    flex: 1, height: 46,
    backgroundColor: Colors.surface,
    borderWidth: 1, borderColor: Colors.border,
    borderRadius: 13,
    alignItems: 'center', justifyContent: 'center',
    gap: 4,
  },
  actionBtnPressed: { opacity: 0.6 },
  actionBtnIcon: { fontSize: 14 },
  actionBtnText: {
    fontSize: 11, fontWeight: '600',
    fontFamily: 'IBMPlexSansArabic_600SemiBold',
    color: Colors.textMuted,
  },
});
```

---

## PART 3 â€” NAVIGATION: tap subscription card â†’ detail screen

### In `DashboardScreen.tsx` â€” update subscription card `onPress`:

```tsx
// Find the subscription card Pressable (or TouchableOpacity) and add:
onPress={() => navigation.navigate('SubscriptionDetail', { subscription: item })}
```

### In `RootNavigator.tsx` â€” add the new screen:

```tsx
import { SubscriptionDetailScreen } from '../screens/SubscriptionDetailScreen';

// Inside Stack.Navigator add:
<Stack.Screen
  name="SubscriptionDetail"
  component={SubscriptionDetailScreen}
  options={{
    headerShown: false,
    // Slide up from bottom on iOS, slide in from right on Android
    ...Platform.select({
      ios: {
        presentation: 'modal',
        animation: 'slide_from_bottom',
      },
      android: {
        animation: 'slide_from_right',
      },
    }),
  }}
/>
```

---

## PART 4 â€” SUPABASE QUERY UPDATE

### In the function that fetches subscriptions for the detail screen, join email data:

```ts
// In mobile/src/lib/subscriptions.ts (or wherever you fetch)

export async function getSubscriptionWithEmail(subscriptionId: string) {
  const { data, error } = await supabase
    .from('subscriptions')
    .select(`
      *,
      emails_raw!source_message_id (
        from_email,
        subject,
        snippet
      )
    `)
    .eq('id', subscriptionId)
    .single();

  if (error) throw error;

  // Flatten the email join
  const email = data.emails_raw?.[0];
  return {
    ...data,
    from_email: email?.from_email ?? null,
    subject: email?.subject ?? null,
    snippet: email?.snippet ?? null,
  };
}
```

---

## EXACT DESIGN RULES â€” MUST NOT DEVIATE

1. **Cancel button background**: `rgba(250,109,138,0.08)` NOT opaque red â€” subtle tinted glass
2. **Cancel button border**: `1.5px solid rgba(250,109,138,0.3)` â€” NOT full opacity
3. **Trial variant cancel button**: amber colors `rgba(250,192,109,*)` throughout â€” NOT red
4. **How-to steps**: numbered circles use `rgba(91,108,248,0.15)` bg with indigo border and accent text
5. **Vertical connector line** between steps: `2px` wide, `Colors.border` color, centered under number circle
6. **Step links** (optional, only some steps have them): indigo pill buttons with `â†—` prefix, open in `WebBrowser.openBrowserAsync`
7. **Cancel button opens `expo-web-browser`** with `PAGE_SHEET` presentation â€” NOT full screen, NOT system Safari
8. **`LayoutAnimation`** used for accordion expand/collapse â€” NOT a height animation (too complex for step connectors)
9. **Arabic numerals** in step numbers when `lang === 'ar'`: Ù¡ Ù¢ Ù£ Ù¤ Ù¥
10. **Hijri date**: use `toLocaleDateString('ar-SA-u-ca-islamic')` â€” shown alongside Gregorian, NOT instead of it
11. **Unknown merchants**: fall back to `_default` in `CANCEL_INFO` and generate a Google search URL
12. **`isKnown` flag**: shown in cancel button subtitle â€” known = "Ø³ÙŠÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø³Ù…ÙŠØ©", unknown = "Ø³ÙŠÙØªØ­ Ø¨Ø­Ø« Google Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"
13. **Confidence bar**: gradient `backgroundColor` matching `confidenceColor()` â€” green for high, amber for mid, red for low
14. **Trial warning card**: only shown when `is_trial === true AND days <= 7` â€” full-width amber-tinted info card

---

## DELIVERABLES CHECKLIST

- [ ] `mobile/src/data/cancelUrls.ts` â€” cancel URL + steps database (all 7 merchants + default)
- [ ] `mobile/src/screens/SubscriptionDetailScreen.tsx` â€” full detail screen
- [ ] `mobile/src/lib/subscriptions.ts` â€” updated query with email join
- [ ] Dashboard subscription card â€” `onPress` navigates to detail
- [ ] `RootNavigator.tsx` â€” `SubscriptionDetail` screen registered
- [ ] `expo-web-browser` installed and used for all external URL opens
- [ ] All text displays in correct language based on `useI18n()` hook